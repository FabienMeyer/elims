name: ELIMS Frontend

on:
  push:
    branches:
      - main
    paths:
      - 'packages/elims-frontend/**'
      - '.github/workflows/frontend.yml'
  pull_request:
    types:
      - opened
      - synchronize
    paths:
      - 'packages/elims-frontend/**'
      - '.github/workflows/frontend.yml'


jobs:

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Bun
        uses: oven-sh/setup-bun@v2

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: bun install

      - name: Run Biome lint
        working-directory: ./frontend
        run: bun run lint

  # test:
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 30
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       shardIndex: [1, 2, 3, 4]
  #       shardTotal: [4]

  #   services:
  #     mariadb:
  #       image: mariadb:11
  #       env:
  #         MARIADB_ROOT_PASSWORD: ${{ secrets.MARIADB_ROOT_PASSWORD || 'testpassword' }}
  #         MARIADB_DATABASE: ${{ secrets.MARIADB_DATABASE || 'elims_test' }}
  #         MARIADB_USER: ${{ secrets.MARIADB_USER || 'elims' }}
  #         MARIADB_PASSWORD: ${{ secrets.MARIADB_PASSWORD || 'testpassword' }}
  #       options: >-
  #         --health-cmd="healthcheck.sh --connect --innodb_initialized"
  #         --health-interval=10s
  #         --health-timeout=5s
  #         --health-retries=5
  #       ports:
  #         - 3306:3306

  #     redis:
  #       image: redis:7-alpine
  #       options: >-
  #         --health-cmd="redis-cli ping"
  #         --health-interval=10s
  #         --health-timeout=3s
  #         --health-retries=5
  #       ports:
  #         - 6379:6379

  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v6

  #     - name: Set up Python
  #       uses: actions/setup-python@v6
  #       with:
  #         python-version: "3.13"

  #     - name: Install uv
  #       uses: astral-sh/setup-uv@v7

  #     - name: Install backend dependencies
  #       working-directory: ./backend
  #       run: uv sync

  #     - name: Install Bun
  #       uses: oven-sh/setup-bun@v2

  #     - name: Install frontend dependencies
  #       working-directory: ./frontend
  #       run: bun install

  #     - name: Install Playwright Browsers
  #       working-directory: ./frontend
  #       run: bunx playwright install chromium --with-deps

  #     - name: Start backend server
  #       working-directory: ./backend
  #       run: |
  #         uv run fastapi dev app/main.py &
  #         sleep 5
  #       env:
  #         MARIADB_HOST: localhost
  #         MARIADB_PORT: 3306
  #         MARIADB_USER: ${{ secrets.MARIADB_USER || 'elims' }}
  #         MARIADB_PASSWORD: ${{ secrets.MARIADB_PASSWORD || 'testpassword' }}
  #         MARIADB_DATABASE: ${{ secrets.MARIADB_DATABASE || 'elims_test' }}
  #         REDIS_HOST: localhost
  #         REDIS_PORT: 6379
  #         REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD || 'testpassword' }}

  #     - name: Run Playwright tests
  #       working-directory: ./frontend
  #       run: bunx playwright test --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}
  #       env:
  #         VITE_API_URL: http://localhost:8000
  #         CI: true

  #     - name: Upload blob report to GitHub Actions Artifacts
  #       if: always()
  #       uses: actions/upload-artifact@v6
  #       with:
  #         name: blob-report-${{ matrix.shardIndex }}
  #         path: frontend/blob-report
  #         retention-days: 1

  # merge-reports:
  #   if: always()
  #   needs: test
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v6

  #     - name: Install Bun
  #       uses: oven-sh/setup-bun@v2

  #     - name: Install frontend dependencies
  #       working-directory: ./frontend
  #       run: bun install

  #     - name: Download blob reports from GitHub Actions Artifacts
  #       uses: actions/download-artifact@v7
  #       with:
  #         path: frontend/all-blob-reports
  #         pattern: blob-report-*
  #         merge-multiple: true

  #     - name: Merge into HTML Report
  #       working-directory: ./frontend
  #       run: bunx playwright merge-reports --reporter html ./all-blob-reports

  #     - name: Upload HTML report
  #       uses: actions/upload-artifact@v6
  #       with:
  #         name: playwright-report
  #         path: frontend/playwright-report
  #         retention-days: 14
